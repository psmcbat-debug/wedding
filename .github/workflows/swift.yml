name: iOS CI (build & test)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CONFIGURATION: Debug
  DERIVED_DATA: build/DerivedData
  DESTINATION: 'platform=iOS Simulator,name=iPhone 15,OS=latest'
  SCHEME: WeddingManager        # <-- mets ici le nom EXACT du scheme Xcode

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      # (Optionnel) Si tu utilises CocoaPods, décommente :
      # - name: Setup Ruby & install CocoaPods
      #   uses: ruby/setup-ruby@v1
      #   with:
      #     ruby-version: '3.3'
      # - run: |
      #     gem install cocoapods --no-document
      #     pod install --repo-update

      - name: List schemes & projects
        run: |
          echo "== Projets =="
          ls -1 *.xcodeproj || true
          echo "== Workspaces =="
          ls -1 *.xcworkspace || true
          echo "== xcodebuild -list =="
          xcodebuild -list || true

      # Détecte automatiquement si c'est un workspace ou un project
      - name: Build for iOS Simulator (no signing)
        run: |
          set -e
          if ls *.xcworkspace 1> /dev/null 2>&1; then
            WS=$(ls *.xcworkspace | head -n1)
            xcodebuild \
              -workspace "$WS" \
              -scheme "$SCHEME" \
              -configuration "$CONFIGURATION" \
              -sdk iphonesimulator \
              -destination "$DESTINATION" \
              -derivedDataPath "$DERIVED_DATA" \
              clean build
          else
            PRJ=$(ls *.xcodeproj | head -n1)
            xcodebuild \
              -project "$PRJ" \
              -scheme "$SCHEME" \
              -configuration "$CONFIGURATION" \
              -sdk iphonesimulator \
              -destination "$DESTINATION" \
              -derivedDataPath "$DERIVED_DATA" \
              clean build
          fi

      - name: Run unit tests (optional)
        continue-on-error: true
        run: |
          set -e
          if ls *.xcworkspace 1> /dev/null 2>&1; then
            WS=$(ls *.xcworkspace | head -n1)
            xcodebuild \
              -workspace "$WS" \
              -scheme "$SCHEME" \
              -sdk iphonesimulator \
              -destination "$DESTINATION" \
              -derivedDataPath "$DERIVED_DATA" \
              test
          else
            PRJ=$(ls *.xcodeproj | head -n1)
            xcodebuild \
              -project "$PRJ" \
              -scheme "$SCHEME" \
              -sdk iphonesimulator \
              -destination "$DESTINATION" \
              -derivedDataPath "$DERIVED_DATA" \
              test
          fi

      - name: Package simulator .app & logs
        run: |
          mkdir -p artifacts
          APP_PATH=$(find "$DERIVED_DATA/Build/Products/$CONFIGURATION-iphonesimulator" -maxdepth 1 -name "*.app" | head -n 1)
          echo "Found app: $APP_PATH"
          if [ -n "$APP_PATH" ]; then
            pushd "$(dirname "$APP_PATH")"
            zip -r "../../../../../artifacts/${SCHEME}-sim-${CONFIGURATION}.zip" "$(basename "$APP_PATH")"
            popd
          fi
          cp -R "$DERIVED_DATA/Logs" "artifacts/Logs" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: artifacts
          retention-days: 7
